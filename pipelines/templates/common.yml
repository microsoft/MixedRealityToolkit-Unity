# [Template] Common build tasks shared between CI builds and PR validation.

parameters:
  UnityVersion: ""
  buildStandalone: false
  buildUWPx86: false
  buildUWPArm: false
  buildUWPArm64: false
  runTests: true

steps:
- powershell: |
    # Module management requires TLS 1.2.
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
    if (-not (Get-InstalledModule -Name UnitySetup)) {
        Install-Module -Name UnitySetup -Scope CurrentUser -Force
    }
  displayName: Install unitysetup.powershell

# Build Standalone x64.
# This must happen before tests run, because if the build fails and tests attempt
# to get run, Unity will hang showing a dialog (even when in batch mode).
# This is the fastest build, since it doesn't produce an AppX.
- ${{ if eq(parameters.buildStandalone, true) }}:
  - template: unity.yaml
    parameters:
      UnityVersion: ${{ parameters.UnityVersion }}
      BuildTarget: StandaloneWindows64
      OutputPath: $(Build.ArtifactStagingDirectory)/mrtk-build-exe-x64/MixedRealityToolkit.exe

# Tests should run earlier in the process, so that engineers can get test failure
# notifications earlier in the CI process.
- ${{ if eq(parameters.runTests, true) }}:
  - template: tests.yml
    parameters:
      UnityVersion: ${{ parameters.UnityVersion }}

# Build UWP.
- ${{ if or(eq(parameters.buildUWPx86, true), eq(parameters.buildUWPArm, true), eq(parameters.buildUWPArm64, true)) }}:
  - template: unity.yaml
    parameters:
      UnityVersion: ${{ parameters.UnityVersion }}
      BuildTarget: WSAPlayer
      OutputPath: $(Agent.TempDirectory)/build/uwp

  # Build UWP x86.
  - ${{ if eq(parameters.buildUWPx86, true) }}:
    - template: tasks/build-appx.yaml
      parameters:
        ProjectName: MixedRealityToolkit
        Architectures: [x86]
        BuildFolderPath: $(Agent.TempDirectory)/build/uwp

    - task: PublishBuildArtifacts@1
      displayName: Publish x86 AppX
      inputs:
        ArtifactName: mrtk-build-x86
        PathToPublish: $(Build.ArtifactStagingDirectory)/Apps/uwp-x86

  # Build UWP ARM.
  - ${{ if eq(parameters.buildUWPArm, true) }}:
    - template: tasks/build-appx.yaml
      parameters:
        ProjectName: MixedRealityToolkit
        Architectures: [ARM]
        BuildFolderPath: $(Agent.TempDirectory)/build/uwp

    - task: PublishBuildArtifacts@1
      displayName: Publish ARM AppX
      inputs:
        ArtifactName: mrtk-build-arm
        PathToPublish: $(Build.ArtifactStagingDirectory)/Apps/uwp-arm

  # Build UWP ARM64.
  - ${{ if eq(parameters.buildUWPArm64, true) }}:
    - template: tasks/build-appx.yaml
      parameters:
        ProjectName: MixedRealityToolkit
        Architectures: [ARM64]
        BuildFolderPath: $(Agent.TempDirectory)/build/uwp

    - task: PublishBuildArtifacts@1
      displayName: Publish ARM64 AppX
      inputs:
        ArtifactName: mrtk-build-arm64
        PathToPublish: $(Build.ArtifactStagingDirectory)/Apps/uwp-arm64
