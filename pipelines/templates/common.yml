# [Template] Common build tasks shared between CI builds and PR validation.

parameters:
  UnityVersion: ""
  buildStandalone: true
  buildUWPArm: true
  buildUWPx86: true
  runTests: true

steps:
# Build Standalone x64.
# This must happen before tests run, because if the build fails and tests attempt
# to get run, Unity will hang showing a dialog (even when in batch mode).
# This is the fastest build, since it doesn't produce an AppX.
- ${{ if eq(parameters.buildStandalone, true) }}:
  - template: tasks/build-unity.yml
    parameters:
      UnityVersion: ${{ parameters.UnityVersion }}
      BuildTarget: StandaloneWindows64
      CommandLineBuildMethod: Microsoft.MixedReality.Toolkit.Build.Editor.UnityPlayerBuildTools.StartCommandLineBuild
      PathToProject: $(Build.Repository.LocalPath)
      OutputPath: $(Build.ArtifactStagingDirectory)/mrtk-build-exe-x64/MixedRealityToolkit.exe
      AdditionalArguments: -sceneList Assets/MRTK/Examples/Demos/HandTracking/Scenes/HandInteractionExamples.unity

# Tests should run earlier in the process, so that engineers can get test failure
# notifications earlier in the CI process.
- ${{ if eq(parameters.runTests, true) }}:
  - template: tests.yml
    parameters:
      UnityVersion: ${{ parameters.UnityVersion }}

# Build UWP.
- ${{ if or(eq(parameters.buildUWPx86, true), eq(parameters.buildUWPArm, true)) }}:
  - template: tasks/build-unity.yml
    parameters:
      UnityVersion: ${{ parameters.UnityVersion }}
      BuildTarget: WSAPlayer
      CommandLineBuildMethod: Microsoft.MixedReality.Toolkit.Build.Editor.UnityPlayerBuildTools.StartCommandLineBuild
      PathToProject: $(Build.Repository.LocalPath)
      OutputPath: $(Agent.TempDirectory)/build/uwp
      AdditionalArguments: -sceneList Assets/MRTK/Examples/Demos/HandTracking/Scenes/HandInteractionExamples.unity

  - task: PowerShell@2
    displayName: Validate build logs
    inputs:
      targetType: filePath
      filePath: ./scripts/ci/validatebuildlog.ps1
      arguments: >
        -LogFile $(Join-Path $(Agent.TempDirectory) "build_WSAPlayer.log")

  # Build UWP x86.
  - ${{ if eq(parameters.buildUWPx86, true) }}:
    - template: tasks/build-appx.yml
      parameters:
        ProjectName: MixedRealityToolkit
        Architectures: [x86]
        BuildFolderPath: $(Agent.TempDirectory)/build/uwp
        OutputPath: $(Build.ArtifactStagingDirectory)/mrtk-build-uwp-x86

    - task: PublishBuildArtifacts@1
      displayName: Publish UWP x86
      inputs:
        ArtifactName: mrtk-build-x86
        PathToPublish: $(Build.ArtifactStagingDirectory)/mrtk-build-uwp-x86

  # Build UWP ARM.
  - ${{ if eq(parameters.buildUWPArm, true) }}:
    - template: tasks/build-appx.yml
      parameters:
        ProjectName: MixedRealityToolkit
        Architectures: [ARM]
        BuildFolderPath: $(Agent.TempDirectory)/build/uwp
        OutputPath: $(Build.ArtifactStagingDirectory)/mrtk-build-uwp-arm

    - task: PublishBuildArtifacts@1
      displayName: Publish UWP ARM
      inputs:
        ArtifactName: mrtk-build-arm
        PathToPublish: $(Build.ArtifactStagingDirectory)/mrtk-build-uwp-arm
